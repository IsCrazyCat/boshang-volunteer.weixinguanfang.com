<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">


    <meta content="" name="MobileOptimized">
    <meta name="viewport"
          content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no">

    <title>活动列表</title>
    <link href="__TMPL__statics/css/stylecity.css" rel="stylesheet" type="text/css">
    <link href="__TMPL__statics/css/style.css" rel="stylesheet" type="text/css">
    <link href="__TMPL__statics/css/css.css" rel="stylesheet" type="text/css">
    <link href="__TMPL__statics/css/cityserverStyle.css" rel="stylesheet" type="text/css">
    <link href="__TMPL__statics/css/cityCommonstyle.css" rel="stylesheet" type="text/css">
    <link href="__TMPL__statics/css/weixinzyzStyle.css" rel="stylesheet" type="text/css">
    <link href="__TMPL__statics/css/style-tmt.css" rel="stylesheet" type="text/css">
    <link href="__TMPL__statics/css/jquery.pager.css" rel="stylesheet" type="text/css">
    <link href="__TMPL__statics/css/WdatePicker.css" rel="stylesheet" type="text/css">
    <link type="text/css" rel="stylesheet" href="__TMPL__statics/css/xiala.css">

    <script src="__TMPL__statics/js/jquery-1.7.1.min.js" type="text/javascript"></script>
    <script type="text/javascript" src="__TMPL__statics/js/goto_email.js"></script>
    <script src="__TMPL__statics/js/jquery.pager.js" type="text/javascript"></script>
    <script type="text/javascript" src="__TMPL__statics/js/WdatePicker.js"></script>
    <script src="__TMPL__statics/js/xiala.js" type="text/javascript"></script>

    <style>
        .grade-e {
            position: absolute;
            z-index: 3;
            left: 100%;
        }

        .grade-e li {
            background-color: #fff;
        }
    </style>

    <script>
        $(function () {
            var regionId = '';
            var regionName = '';
            var missionTypeId = '';
            var missionTypeName = '';
            var orderParam = '';
            var orderStr = '';
            var keyWordParam = '';
            if (regionName && regionName != 'undefined' && regionId && regionId != 'undefined') {

                $(".Regional").html(regionName);
                $(".Regional").attr("value", regionId);
                $(".Regional").attr("value", $("#gradew li").eq(regionId).html());
            }

            if (missionTypeId && missionTypeId != 'undefined' && missionTypeName && missionTypeName != 'undefined') {

                $(".Brand").attr("value", missionTypeId);
                $(".Brand").attr("value", $(this).attr("value") == 0 ? "" : $(this).attr("value"));
                $(".Brand").html(missionTypeName);
            }

            if (orderParam && orderParam != 'undefined' && orderStr && orderStr != 'undefined') {

                $(".Sort").attr("value", orderParam);
                $(".Sort").attr("value", $(this).attr("value"));
                $(".Sort").html(orderStr);
            }

            if (keyWordParam && keyWordParam != 'undefined') {

                $("#searchText").val(keyWordParam);
                $(".searchBox03").attr("value", $("#searchText").val());
                //$(".searchBox03").html('');
            }

            var Regional = $(".Regional").attr("value");
            var Brand = $(".Brand").attr("value");
            var Sort = $(".Sort").attr("value");
            var searchBox03 = $(".searchBox03").attr("value");

            var pageNo = 1;
            var loadURL = "";
            var html = "	<li style='clear:both; overflow:hidden;position:relative;'>";
            html = html + "		<a href=''>";
            html = html + "			<p id='abc' class='XmlbListZhuantai XmlbListZhuantaiBgRed' style='position:absolute; top:10px;right:10px;'>aaa</p>";
            html = html + "			<img src='' class='XmlbListImg'/>";
            html = html + "			<div class='listTitle'></div>";
            html = html + "			<div class='listOrg'></div>";
            html = html + "			<div class='listTime'>发布时间：</div>";
            html = html + "			<p class='XmlbListZhuantai' id='XmlbListZhuantai' style='position: absolute; top: 60px; right: 9px; color: black;width:auto'><img src='__TMPL__statics/img/index/scan-count.png' alt='logo' />&nbsp;</p>";
            html = html + "		</a>";
            html = html + "	</li>";
            html = html + "	<div class='clear'></div>";

            loadJosn(pageNo,'','','','');

            $("#gradew li:first").unbind("click");

            $("#gradew li").click(function () {
                if ("不限" == $(this).html()) {
                    $("#cotent").html("");
                    pageNo = 1;
                    hiddenlayer();
                    $(".Regional").attr("value", "");
                    $(".Regional").html("区域");
                    loadJosn(pageNo,"", $(".Brand").attr("value"), $(".Sort").attr("value"), $(".searchBox03").attr("value"));
                } else {
                    var tempIndex = $(this).index();
                    var tempVal = $(this).attr("value");

                    $("#gradet li").not(":first").hide();
                    $("#gradet li").each(function () {
                        if($(this).attr('name')==('cityId'+tempVal)){
                            $(this).show();
                        }
                    });
                    $("#gradet li:first").unbind("click");
                    $("#gradet li").click(function () {
                        if ("不限" == $(this).html()) {
                            $("#cotent").html("");
                            pageNo = 1;
                            $(".Regional").attr("value", $("#gradew li").eq(tempIndex).html());
                            loadJosn( pageNo,"city_id="+tempVal, $(".Brand").attr("value"), $(".Sort").attr("value"), $(".searchBox03").attr("value"));
                            $(".Regional").html($("#gradew li").eq(tempIndex).html().substring(0, 2) + "...");
                            $('.grade-e').css('left', '100%');
                            hiddenlayer();
                            return false;
                        }else {
                            var tempIndex2 = $(this).index();
                            var tempVal2 = $(this).attr("value");

                            if ($("#gradee li").length == 1) {
                                $(".Regional").attr("value", $("#gradet li").eq(tempIndex2).html());
                                pageNo = 1;
                                loadJosn(pageNo,"area_id="+tempVal2, $(".Brand").attr("value"), $(".Sort").attr("value"), $(".searchBox03").attr("value"));
                                $(".Regional").html($("#gradet li").eq(tempIndex2).html().substring(0, 2) + "...");
                                hiddenlayer();
                                return false;
                            }else{
                                $("#gradee li").not(":first").hide();
                                $("#gradee li").each(function () {
                                    if($(this).attr('name')==('areaId'+tempVal2)){
                                        $(this).show();
                                    }
                                });
                            }
                            $("#gradee li:first").unbind("click");

                            $("#gradee li").click(function () {
                                if ("不限" == $(this).html()) {
                                    $("#cotent").html("");
                                    pageNo = 1;
                                    $(".Regional").attr("value", $("#gradet li").eq(tempIndex2).html());
                                    loadJosn(pageNo,"area_id="+tempVal2, $(".Brand").attr("value"), $(".Sort").attr("value"), $(".searchBox03").attr("value"));
                                    $(".Regional").html($("#gradet li").eq(tempIndex2).html().substring(0, 2) + "...");
                                    $('.grade-e').css('left', '100%');
                                    hiddenlayer();
                                    return false;
                                } else {
                                    $("#cotent").html("");
                                    $(".Regional").attr("value", $(this).html());
                                    $('.grade-e').css("left","66%");
                                    pageNo = 1;
                                    loadJosn(pageNo,$(".Regional").attr("value"), $(".Brand").attr("value"), $(".Sort").attr("value"), $(".searchBox03").attr("value"));
                                    $(".Regional").html($(this).html().substring(0, 2) + "...");
                                    hiddenlayer();
                                    return false;
                                }
                            });
                            $('.grade-e').css("left", "66%");
                        }
                    });
                }
            });

            $("#Categorys li").click(function () {
                $("#cotent").html("");
                hiddenlayer();
                pageNo = 1;
                $(".Brand").attr("value", $(this).attr("value") == 0 ? "" : $(this).attr("value"));
                loadJosn(pageNo,$(".Regional").attr("value"), $(".Brand").attr("value"), $(".Sort").attr("value"), $(".searchBox03").attr("value"));
                if ($(this).index() == 0) {
                    $(".Brand").html("类型");
                    return false;
                }
                $(".Brand").html($(this).html().substring(0, 2) + "...");
            });

            var orderFlag = 1;
            $("#Sort-Sort li").click(function () {
                $("#cotent").html("");
                hiddenlayer();
                pageNo = 1;
                $(".Sort").attr("value", $(this).attr("value"));
                loadJosn(pageNo,$(".Regional").attr("value"), $(".Brand").attr("value"), $(".Sort").attr("value"), $(".searchBox03").attr("value"));
                if ($(this).index() == 0) {
                    $(".Sort").html("排序");
                    return false;
                }
                $(".Sort").html($(this).html().substring(0, 2) + "...");
            });

            //继承点击，作隐藏用
            $(".screening>ul>li").click(function () {
                $.each($("#searchObj>div").eq($(this).index()).siblings(), function () {
                    if ($(this).hasClass('grade-w-roll')) {
                        $(this).removeClass('grade-w-roll');
                    }
                });
            });

            //点击加载更多
            $("#loadMore").click(function () {
                if ($("#loadMore").html() == "加载更多...") {
                    loadJosn(++pageNo,$(".Regional").attr("value"), $(".Brand").attr("value"), $(".Sort").attr("value"), $(".searchBox03").attr("value"));
                    return false;
                }
            });


            $("#search_btn").click(function () {
                $("#cotent").html("");
                hiddenlayer();
                pageNo = 1;
                $(".searchBox03").attr("value", $("#searchText").val());
                loadJosn(pageNo,$(".Regional").attr("value"), $(".Brand").attr("value"), $(".Sort").attr("value"), $(".searchBox03").attr("value"));
            });

            //初始页面加载	分页json
            function loadJosn(pageNo,shop_id,cate_id,order,search_key) {
                $("#background").show();
                $("#progressBar").show();
                $.ajax({
                    // url: "<{:U('activity/moreActivity',array('p'=>"+pageNo+"))}>",
                    url:"/wap/activity/moreActivity/p/"+pageNo,
                    data: {
                        "shop_id":shop_id,
                        "cate_id":cate_id,
                        "order":order,
                        "search_key":search_key
                    },
                    dataType: "json",
                    type: 'post',
                    success: function (data) {
                        if (data.list==null && pageNo == 1) {
                            $("#loadMore").html("暂无此类活动");
                        } else{
                            if (data.list.length > 0 && data.list.length < 10 && pageNo >= 1) {
                                $("#loadMore").html("");
                            } else {
                                $("#loadMore").html("加载更多...");
                            }
                            $.each(data.list, function (i) {
                                //tmpURL是跳转页面路径
                                // var tmpURL = "<{:U('activity/index'),array('activity_id'=>"+data.list[i].activity_id+")}>";
                                var tmpURL = "/wap/activity/detail/activity_id/"+data.list[i].activity_id;
                                // var tmpURL = loadURL + data.list[i].missionId + "&venue=" + regionName + "&missionType=" + missionTypeId + "&order=" + orderParam + "&keyWord=" + keyWordParam + "&currentPage=" + pageNo + "&districtId=" + districtId + "&pageType=missionList";
                                //活动缩略图路径
                                var imgSrc = data.list[i].photo;

                                //这里是组织名称
                                var tempdistrictName = data.list[i].shop_name.substring(0, 12);
                                if (tempdistrictName.length >= 12) {
                                    tempdistrictName = tempdistrictName.substring(0, 12) + "...";
                                }

                                var is_end = data.list[i].sign_end;
                                var current_time = new Date();
                                var sign_end = new Date(is_end.replace("-", "/").replace("-", "/"));
                                if (sign_end>=current_time) {
                                    $("#cotent").append(
                                        $(html).find(".listTitle").html(data.list[i].title).end()
                                            .find(".listOrg").html("[" + tempdistrictName + "]").end()
                                            .find(".listTime").html("发布时间：" + data.list[i].bg_date).end()
                                            .find("#abc").html("报名").end()
                                            .find("#XmlbListZhuantai").append(data.list[i].sign_num).end()
                                            .find(".XmlbListImg").attr({
                                            "src": imgSrc
                                        }).end()
                                            .find("a").attr("href", tmpURL).end().prop("outerHTML")
                                    );
                                } else {
                                    $("#cotent").append(
                                        $(html).find(".listTitle").html(data.list[i].title).end()
                                            .find(".listOrg").html("[" + tempdistrictName + "]").end()
                                            .find(".listTime").html("发布时间：" + data.list[i].bg_date).end()
                                            .find("#abc").html("结束").end()
                                            .find("#XmlbListZhuantai").append(data.list[i].sign_num).end()
                                            .find(".XmlbListImg").attr({
                                            "src": imgSrc
                                        }).end()
                                            .find("a").attr("href", tmpURL).end().prop("outerHTML")
                                    );
                                }

                            });
                        }



                        $("#background").hide();
                        $("#progressBar").hide();
                    },
                    error: function (jqXHR, textStatus, errorThrown) {
                        // /*弹出jqXHR对象的信息*/
                        // alert(jqXHR.responseText);
                        // alert(jqXHR.status);
                        // alert(jqXHR.readyState);
                        // alert(jqXHR.statusText);
                        // /*弹出其他两个参数的信息*/
                        // alert(textStatus);
                        // alert(errorThrown);
                    }
                });
            }
            function hiddenlayer() {
                $.each($("#searchObj>div"), function (i) {
                    if ($(this).hasClass('grade-w-roll')) {
                        $(this).removeClass('grade-w-roll');
                    }
                });
            }
        });
    </script>

</head>

<body class="bodybg">
<!-- screening -->
<div class="screening" style="top: 0px;">
    <ul>
        <li style="font-size: 14px; border-left: none;" ca="" class="Regional" value="">地域</li>
        <li style="font-size: 14px;" ca="" class="Brand" value="">类型</li>
        <li style="font-size: 14px;" ca="" class="Sort" value="">排序</li>
        <li style="font-size: 14px;" ca="" class="searchBox03" value="">搜索</li>
    </ul>
</div>
<!-- End screening -->

<!-- grade -->
<div id="searchObj" style="position: fixed; z-index: 3;">
    <div class="grade-eject">
        <ul class="grade-w" id="gradew">
            <li value="" onclick="grade1(this)">不限</li>
            <foreach name="citys" item="v">
                <li value="<{$v.city_id}>" onclick="grade1(this)"><{$v.name}></li>
            </foreach>
        </ul>
        <ul class="grade-t" id="gradet">
            <li value="" onclick="gradet(this);">不限</li>
            <foreach name="areas" item="v">
                <li value="<{$v.area_id}>" name = "cityId<{$v.city_id}>"onclick="gradet(this);"><{$v.area_name}></li>
            </foreach>
        </ul>
        <ul class="grade-e" id="gradee">
            <li value="" onclick="grades(this);">不限</li>
            <foreach name="shops" item="v">
                <li value="<{$v.shop_id}>" name = "areaId<{$v.area_id}>" onclick="grades(this);"><{$v.shop_name}></li>
            </foreach>
        </ul>
    </div>
    <!-- End grade -->

    <!-- Category -->
    <div class="Category-eject">
        <ul class="Sort-Sort" id="Categorys" style="height: 100%;">
            <li value="">不限</li>
            <foreach name="cates" item="v">
                <li value="<{$v.cate_id}>"><{$v.cate_name}></li>
            </foreach>
        </ul>

    </div>
    <!-- End Category -->

    <!-- Sort -->
    <div class="Sort-eject Sort-height">
        <ul class="Sort-Sort" id="Sort-Sort">
            <li value="">不限</li>
            <li value="1">开始时间先后</li>
            <li value="2">浏览人数最多</li>
        </ul>
    </div>
    <!-- End Sort -->

    <div class="searchBox search-height text001">
        <ul class="search-Bbox" id="search-Bbox" style="height: auto;">
            <li style="height: 50px; line-height: 50px;" class="wenbeninput">
                <input id="searchText" type="text" placeholder="请输入搜索内容">
            </li>
            <a href="javascript:;" class="message_Btn" id="search_btn"
               style="border-radius: 2px; background-color: rgb(219, 68, 82); color: #fff; display: block; height: 40px; line-height: 40px; width: 90%; margin-left: auto; margin-right: auto;">
                搜索
            </a>
        </ul>
    </div>
</div>
<!-- End Category -->

<div class="mbottom10" style="margin-top: 38px;">

		<span>

		</span>

    <ul class="XmlbListContainer" id="cotent">
    </ul>

    <div id="background" class="background" style="display: none;"></div>
    <div id="progressBar" class="progressBar" style="display: none;">
        <img style="width: 30px; height: 30px;" src="__TMPL__statics/img/index/loading.gif">
    </div>
    <div style="height: 50px; line-height: 50px; text-align: center; font-size: 14px;" id="loadMore">加载更多...</div>
</div>


<script type="text/javascript">
    // 点击改变背景颜色
    $('.XmlbListContainer>li').mousedown(function (event) {
        $(this).css('background-color', '#f3f3f3');
        $(this).siblings().css('background-color', '#fff');
    });
</script>

</div>
</body>
</html>