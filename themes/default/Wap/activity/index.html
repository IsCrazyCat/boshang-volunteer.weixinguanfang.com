<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">


    <meta content="" name="MobileOptimized">
    <meta name="viewport"
          content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no">

    <title>活动列表</title>
    <link href="__TMPL__statics/css/stylecity.css" rel="stylesheet" type="text/css">
    <link href="__TMPL__statics/css/style.css" rel="stylesheet" type="text/css">
    <link href="__TMPL__statics/css/css.css" rel="stylesheet" type="text/css">
    <link href="__TMPL__statics/css/cityserverStyle.css" rel="stylesheet" type="text/css">
    <link href="__TMPL__statics/css/cityCommonstyle.css" rel="stylesheet" type="text/css">
    <link href="__TMPL__statics/css/weixinzyzStyle.css" rel="stylesheet" type="text/css">
    <link href="__TMPL__statics/css/style-tmt.css" rel="stylesheet" type="text/css">
    <link href="__TMPL__statics/css/jquery.pager.css" rel="stylesheet" type="text/css">
    <link href="__TMPL__statics/css/WdatePicker.css" rel="stylesheet" type="text/css">
    <link type="text/css" rel="stylesheet" href="__TMPL__statics/css/xiala.css">

    <script src="__TMPL__statics/js/jquery-1.7.1.min.js" type="text/javascript"></script>
    <script type="text/javascript" src="__TMPL__statics/js/goto_email.js"></script>
    <script src="__TMPL__statics/js/jquery.pager.js" type="text/javascript"></script>
    <script type="text/javascript" src="__TMPL__statics/js/WdatePicker.js"></script>
    <script src="__TMPL__statics/js/xiala.js" type="text/javascript"></script>

    <style>
        .grade-e {
            position: absolute;
            z-index: 3;
            left: 100%;
        }

        .grade-e li {
            background-color: #fff;
        }
    </style>

    <script>
        $(function () {
            var regionId = '';
            var regionName = '';
            var missionTypeId = '';
            var missionTypeName = '';
            var orderParam = '';
            var orderStr = '';
            var keyWordParam = '';
            if (regionName && regionName != 'undefined' && regionId && regionId != 'undefined') {

                $(".Regional").html(regionName);
                $(".Regional").attr("val", regionId);
                $(".Regional").attr("val", $("#gradew li").eq(regionId).html());
            }

            if (missionTypeId && missionTypeId != 'undefined' && missionTypeName && missionTypeName != 'undefined') {

                $(".Brand").attr("val", missionTypeId);
                $(".Brand").attr("val", $(this).attr("value") == 0 ? "" : $(this).attr("value"));
                $(".Brand").html(missionTypeName);
            }

            if (orderParam && orderParam != 'undefined' && orderStr && orderStr != 'undefined') {

                $(".Sort").attr("val", orderParam);
                $(".Sort").attr("val", $(this).attr("value"));
                $(".Sort").html(orderStr);
            }

            if (keyWordParam && keyWordParam != 'undefined') {

                $("#searchText").val(keyWordParam);
                $(".searchBox03").attr("val", $("#searchText").val());
                //$(".searchBox03").html('');
            }

            var Regional = $(".Regional").attr("val");
            var Brand = $(".Brand").attr("val");
            var Sort = $(".Sort").attr("val");
            var searchBox03 = $(".searchBox03").attr("val");

            var pageNo = 1;
            var loadURL = "";
            var html = "	<li style='clear:both; overflow:hidden;position:relative;'>";
            html = html + "		<a href=''>";
            html = html + "			<p id='abc' class='XmlbListZhuantai XmlbListZhuantaiBgRed' style='position:absolute; top:10px;right:10px;'>aaa</p>";
            html = html + "			<img src='' onerror=changeImg(this,'test') class='XmlbListImg'/>";
            html = html + "			<div class='listTitle'></div>";
            html = html + "			<div class='listOrg'></div>";
            html = html + "			<div class='listTime'>发布时间：</div>";
            html = html + "			<p class='XmlbListZhuantai' id='XmlbListZhuantai' style='position: absolute; top: 60px; right: 9px; color: black;width:auto'><img src='__TMPL__statics/img/index/scan-count.png' alt='logo' />&nbsp;</p>";
            html = html + "		</a>";
            html = html + "	</li>";
            html = html + "	<div class='clear'></div>";

            loadJosn(pageNo);




            $("#gradew li:first").unbind("click");

            $("#gradew li").click(function () {
                if ("不限" == $(this).html()) {
                    var tempRegionlist = new Array();
                    pageNo = 1;
                    hiddenlayer();
                    $(".Regional").attr("val", "");
                    $(".Regional").html("区域");
                    searchJson($(".Regional").attr("val"), $(".Brand").attr("val"), $(".Sort").attr("val"), $(".searchBox03").attr("val"), pageNo);
                } else {
                    var tempIndex = $(this).index();
                    var tempVal = $(this).attr("val");
                    $.ajax({
                        url: "/region/region/getRegionsListJson.do",
                        data: {regionId: tempVal},
                        dataType: "json",
                        async: false,
                        success: function (data) {
                            $("#gradet li").not(":first").remove();
                            $.each(data.data, function (i) {
                                $("#gradet").append("<li value='" + data.data[i].id + "' onclick='gradet(this)'>" + data.data[i].name + "</li>");
                            });

                            $("#gradet li:first").unbind("click");

                            $("#gradet li").click(function () {
                                /* hiddenlayer(); */
                                var tempRegion = "";
                                if ("不限" == $(this).html()) {
                                    $.each($(this).siblings(), function (i) {
                                        tempRegion = tempRegion + "," + $(this).attr("value");
                                    });
                                    tempRegion = tempVal + tempRegion;
                                    pageNo = 1;

                                    $(".Regional").attr("val", $("#gradew li").eq(tempIndex).html());
                                    searchJson($(".Regional").attr("val"), $(".Brand").attr("val"), $(".Sort").attr("val"), $(".searchBox03").attr("val"), pageNo);
                                    $(".Regional").html($("#gradew li").eq(tempIndex).html().substring(0, 2) + "...");
                                    $('.grade-e').css('left', '100%');
                                    hiddenlayer();
                                    return false;
                                } else {
                                    var tempIndex2 = $(this).index();
                                    var tempVal2 = $(this).attr("value");
                                    $.ajax({
                                        url: "/region/region/getRegionsListJson.do",
                                        data: {regionId: tempVal2},
                                        dataType: "json",
                                        async: false,
                                        success: function (data) {
                                            $("#gradee li").not(":first").remove();
                                            if (data.data.length == 0) {
                                                $(".Regional").attr("val", $("#gradet li").eq(tempIndex2).html());
                                                pageNo = 1;
                                                searchJson($(".Regional").attr("val"), $(".Brand").attr("val"), $(".Sort").attr("val"), $(".searchBox03").attr("val"), pageNo);
                                                $(".Regional").html($("#gradet li").eq(tempIndex2).html().substring(0, 2) + "...");
                                                hiddenlayer();
                                                return false;
                                            }
                                            $.each(data.data, function (i) {
                                                $("#gradee").append("<li value='" + data.data[i].id + "' onclick='grades(this)'>" + data.data[i].name + "</li>");
                                            });

                                            $("#gradee li:first").unbind("click");

                                            $("#gradee li").click(function () {
                                                var tempRegion2 = "";
                                                if ("不限" == $(this).html()) {
                                                    $.each($(this).siblings(), function (i) {
                                                        tempRegion2 = tempRegion2 + "," + $(this).attr("value");
                                                    });
                                                    tempRegion2 = tempVal2 + tempRegion2;
                                                    pageNo = 1;

                                                    $(".Regional").attr("val", $("#gradet li").eq(tempIndex2).html());
                                                    searchJson($(".Regional").attr("val"), $(".Brand").attr("val"), $(".Sort").attr("val"), $(".searchBox03").attr("val"), pageNo);
                                                    $(".Regional").html($("#gradet li").eq(tempIndex2).html().substring(0, 2) + "...");
                                                    $('.grade-e').css('left', '100%');
                                                    hiddenlayer();
                                                    return false;
                                                } else {
                                                    $(".Regional").attr("val", $(this).html());
                                                    //$('.grade-e').css("left","66%");
                                                    pageNo = 1;

                                                    searchJson($(".Regional").attr("val"), $(".Brand").attr("val"), $(".Sort").attr("val"), $(".searchBox03").attr("val"), pageNo);
                                                    $(".Regional").html($(this).html().substring(0, 2) + "...");
                                                    hiddenlayer();
                                                    return false;
                                                }
                                            });
                                            $('.grade-e').css("left", "66%");
                                        }
                                    });
                                }
                            });
                        },
                        error: function () {
                        }
                    });
                }
            });



            $("#Categorys li").click(function () {
                hiddenlayer();
                pageNo = 1;
                $(".Brand").attr("val", $(this).attr("value") == 0 ? "" : $(this).attr("value"));
                searchJson($(".Regional").attr("val"), $(".Brand").attr("val"), $(".Sort").attr("val"), $(".searchBox03").attr("val"), pageNo);
                if ($(this).index() == 0) {
                    $(".Brand").html("类型");
                    return false;
                }
                $(".Brand").html($(this).html().substring(0, 2) + "...");
            });

            $("#Sort-Sort li").click(function () {
                hiddenlayer();
                pageNo = 1;
                $(".Sort").attr("val", $(this).attr("value"));
                searchJson($(".Regional").attr("val"), $(".Brand").attr("val"), $(".Sort").attr("val"), $(".searchBox03").attr("val"), pageNo);
                if ($(this).index() == 0) {
                    $(".Sort").html("排序");
                    return false;
                }
                $(".Sort").html($(this).html().substring(0, 2) + "...");
            });

            //继承点击，作隐藏用
            $(".screening>ul>li").click(function () {
                $.each($("#searchObj>div").eq($(this).index()).siblings(), function () {
                    if ($(this).hasClass('grade-w-roll')) {
                        $(this).removeClass('grade-w-roll');
                    }
                });
            });

            //点击加载更多
            $("#loadMore").click(function () {
                if ($("#loadMore").html() == "加载更多...") {
                    if ($(".Regional").attr("val") != "" || $(".Brand").attr("val") != "" || $(".Sort").attr("val") != "" || $(".searchBox03").attr("val") != "") {
                        searchJson($(".Regional").attr("val"), $(".Brand").attr("val"), $(".Sort").attr("val"), $(".searchBox03").attr("val"), ++pageNo);
                        return false;
                    }
                    loadJosn(++pageNo);
                }
            });


            $("#search_btn").click(function () {
                hiddenlayer();
                pageNo = 1;
                $(".searchBox03").attr("val", $("#searchText").val());
                searchJson($(".Regional").attr("val"), $(".Brand").attr("val"), $(".Sort").attr("val"), $(".searchBox03").attr("val"), pageNo);
            });


            var districtId = "";

            //初始页面加载	分页json
            function loadJosn(pageNo) {

                $("#background").show();
                $("#progressBar").show();
                $.ajax({
                    url: "<{:U('activity/moreActivity')}>",
                    data: {
                        "p": pageNo
                    },
                    dataType: "json",
                    type: 'post',
                    success: function (data) {
                        if (data.list.length == 0 && pageNo == 1) {
                            $("#loadMore").html("暂无此类活动");
                        } else if (data.list.length > 0 && data.list.length < 10 && pageNo >= 1) {
                            $("#loadMore").html("");
                        } else {
                            $("#loadMore").html("加载更多...");
                        }


                        $.each(data.list, function (i) {
                            //tmpURL是跳转页面路径
                            var tmpURL = "";
                            // var tmpURL = loadURL + data.list[i].missionId + "&venue=" + regionName + "&missionType=" + missionTypeId + "&order=" + orderParam + "&keyWord=" + keyWordParam + "&currentPage=" + pageNo + "&districtId=" + districtId + "&pageType=missionList";
                            var imgSrc = data.list[i].photo;

                            //这里是组织名称
                            var tempdistrictName = data.list[i].shop_name.substring(0, 12);
                            if (tempdistrictName.length >= 12) {
                                tempdistrictName = tempdistrictName.substring(0, 12) + "...";
                            }

                            var is_end = data.list[i].sign_end;
                            var current_time = new Date();
                            var sign_end = new Date(is_end.replace("-", "/").replace("-", "/"));
                            if (sign_end>=current_time) {
                                $("#cotent").append(
                                    $(html).find(".listTitle").html(data.list[i].title).end()
                                        .find(".listOrg").html("[" + tempdistrictName + "]").end()
                                        .find(".listTime").html("发布时间：" + data.list[i].bg_date).end()
                                        .find("#abc").html("报名").end()
                                        .find("#XmlbListZhuantai").append(data.list[i].sign_num).end()
                                        .find(".XmlbListImg").attr({
                                        "src": imgSrc
                                    }).end()
                                        .find("a").attr("href", tmpURL).end().prop("outerHTML")
                                );
                            } else {
                                $("#cotent").append(
                                    $(html).find(".listTitle").html(data.list[i].title).end()
                                        .find(".listOrg").html("[" + tempdistrictName + "]").end()
                                        .find(".listTime").html("发布时间：" + data.list[i].bg_date).end()
                                        .find("#abc").html("结束").end()
                                        .find("#XmlbListZhuantai").append(data.list[i].sign_num).end()
                                        .find(".XmlbListImg").attr({
                                        "src": imgSrc
                                    }).end()
                                        .find("a").attr("href", tmpURL).end().prop("outerHTML")
                                );
                            }

                        });
                        $("#background").hide();
                        $("#progressBar").hide();
                    },
                    error: function (jqXHR, textStatus, errorThrown) {
                        // /*弹出jqXHR对象的信息*/
                        // alert(jqXHR.responseText);
                        // alert(jqXHR.status);
                        // alert(jqXHR.readyState);
                        // alert(jqXHR.statusText);
                        // /*弹出其他两个参数的信息*/
                        // alert(textStatus);
                        // alert(errorThrown);
                    }
                });
            }

            function searchJson(venue, missionType, order, keyWord, pageNo) {
                $("#background").show();
                $("#progressBar").show();
                var pathname = window.location.pathname;//返回当前 URL的路径部分-"/cczyz_weixin/mission/mission/missionDetails.action"
                var searchParamsUrl = "?venue=" + venue + "&missionType=" + missionType + "&order=" + order + "&keyWord=" + keyWord + "&currentPage=" + pageNo + "&pageType=missionList";
                if ('') {

                    searchParamsUrl += "&districtId=";
                }

                var url = pathname + searchParamsUrl;
                //(window.)history.pushState(null, null, url);//pushState和replaceState是一个HTML5的新接口，可以做到改变网址却不需要刷新页面

                window.history.pushState(null, null, url);

                $.ajax({
                    url: "/api/wx/mission/searchMissionJson.action",
                    data: {
                        venue: venue,
                        missionType: missionType,
                        order: order,
                        keyWord: keyWord,
                        currentPage: pageNo,
                        districtId: districtId
                    },
                    dataType: "json",
                    type: 'GET',
                    success: function (data) {

                        if (pageNo == 1) {
                            $("#cotent").empty();
                        }
                        if (data.data.length == 0 && pageNo == 1) {
                            $("#loadMore").html("暂无此类活动");
                        } else if (data.data.length > 0 && data.data.length < 10 && pageNo >= 1) {
                            $("#loadMore").html("");
                        } else {
                            $("#loadMore").html("加载更多...");
                        }

                        $.each(data.data, function (i) {
                            var tmpURL = loadURL + data.data[i].missionId + "&venue=" + venue + "&missionType=" + missionType + "&order=" + order + "&keyWord=" + keyWord + "&currentPage=" + pageNo + "&districtId=" + districtId + "&pageType=missionList";
                            var imgSrc = "https://gdftp.oss-cn-shenzhen.aliyuncs.com" + data.data[i].mission_image;
                            var image = data.data[i].mission_image;
                            if (imgSrc == "") {
                                imgSrc = "http://www.gdzyz.cn/error.png";
                            }

                            var tempdistrictName = data.data[i].districtName.substring(0, 12);
                            if (tempdistrictName.length >= 12) {
                                tempdistrictName = tempdistrictName.substring(0, 12) + "...";
                            }

                            var isApply = data.data[i].isApply;
                            if (isApply == 1) {
                                $("#cotent").append(
                                    $(html).find(".listTitle").html(data.data[i].subject).end()
                                        .find(".listOrg").html("[" + tempdistrictName + "]").end()
                                        .find(".listTime").html("发布时间：" + data.data[i].cDatetime).end()
                                        .find("#abc").html("报名").end()
                                        .find("#XmlbListZhuantai").append(data.data[i].browseCount).end()
                                        .find(".XmlbListImg").attr({
                                        "src": imgSrc,
                                        "onerror": "changeImg(this,'" + image + "'," + data.data[i].missionId + ")"
                                    }).end()
                                        .find("a").attr("href", tmpURL).end().prop("outerHTML")
                                );
                            } else {
                                $("#cotent").append(
                                    $(html).find(".listTitle").html(data.data[i].subject).end()
                                        .find(".listOrg").html("[" + tempdistrictName + "]").end()
                                        .find(".listTime").html("发布时间：" + data.data[i].cDatetime).end()
                                        .find("#abc").html("结束").end()
                                        .find("#XmlbListZhuantai").append(data.data[i].browseCount).end()
                                        .find(".XmlbListImg").attr({
                                        "src": imgSrc,
                                        "onerror": "changeImg(this,'" + image + "'," + data.data[i].missionId + ")"
                                    }).end()
                                        .find("a").attr("href", tmpURL).end().prop("outerHTML")
                                );
                            }
                        });
                        $("#background").hide();
                        $("#progressBar").hide();
                    },
                    error: function () {

                    }
                });
            }

            function hiddenlayer() {
                $.each($("#searchObj>div"), function (i) {
                    if ($(this).hasClass('grade-w-roll')) {
                        $(this).removeClass('grade-w-roll');
                    }
                });
            }
        });
    </script>

    <script type="text/javascript">
        function changeImg(img, url, id) {
            var idx = id % 24 + 1;
            img.src = window.location.protocol + "//gdftp.oss-cn-shenzhen.aliyuncs.com/defaultPic/defaultPic_" + idx + ".jpg";
            img.onerror = null;
        }

        function GetRandomNum(Min, Max) {
            var Range = Max - Min;
            var Rand = Math.random();
            return (Min + Math.round(Rand * Range));
        }
    </script>

</head>

<body class="bodybg">
<!-- screening -->
<div class="screening" style="top: 0px;">
    <ul>
        <li style="font-size: 14px; border-left: none;" ca="" class="Regional" val="">地域</li>
        <li style="font-size: 14px;" ca="" class="Brand" val="">类型</li>
        <li style="font-size: 14px;" ca="" class="Sort" val="">排序</li>
        <li style="font-size: 14px;" ca="" class="searchBox03" val="">搜索</li>
    </ul>
</div>
<!-- End screening -->

<!-- grade -->
<div id="searchObj" style="position: fixed; z-index: 3;">
    <div class="grade-eject">
        <ul class="grade-w" id="gradew">
            <li value="" onclick="grade1(this)">不限</li>
            <foreach name="citys" item="v">
                <li val="<{$v.city_id}>" onclick="grade1(this)"><{$v.name}></li>
            </foreach>
        </ul>
        <ul class="grade-t" id="gradet">
            <li value="" onclick="gradet(this);">不限</li>
        </ul>
        <ul class="grade-e" id="gradee">
            <li value="" onclick="grades(this);">不限</li>
        </ul>
    </div>
    <!-- End grade -->

    <!-- Category -->
    <div class="Category-eject">
        <ul class="Sort-Sort" id="Categorys" style="height: 100%;">
            <li value="">不限</li>
            <foreach name="cates" item="v">
                <li value="<{$v.cate_id}>"><{$v.cate_name}></li>
            </foreach>
        </ul>

    </div>
    <!-- End Category -->

    <!-- Sort -->
    <div class="Sort-eject Sort-height">
        <ul class="Sort-Sort" id="Sort-Sort">
            <li value="">不限</li>
            <li value="1">开始时间先后</li>
            <li value="2">浏览人数最多</li>
        </ul>
    </div>
    <!-- End Sort -->

    <div class="searchBox search-height text001">
        <ul class="search-Bbox" id="search-Bbox" style="height: auto;">
            <li style="height: 50px; line-height: 50px;" class="wenbeninput">
                <input id="searchText" type="text" placeholder="请输入搜索内容">
            </li>
            <a href="javascript:;" class="message_Btn" id="search_btn"
               style="border-radius: 2px; background-color: rgb(219, 68, 82); color: #fff; display: block; height: 40px; line-height: 40px; width: 90%; margin-left: auto; margin-right: auto;">
                搜索
            </a>
        </ul>
    </div>
</div>
<!-- End Category -->

<div class="mbottom10" style="margin-top: 38px;">

		<span>

		</span>

    <ul class="XmlbListContainer" id="cotent">
        <li style="clear:both; overflow:hidden;position:relative;"><a
                href="">
            <p id="abc" class="XmlbListZhuantai XmlbListZhuantaiBgRed" style="position:absolute; top:10px;right:10px;">
                结束</p>            <img src="__TMPL__statics/img/index/defaultPic_3.jpg"
                                       class="XmlbListImg">
            <div class="listTitle"> 2019 年河源市禁毒志愿者业务培训班</div>
            <div class="listOrg">[河源市禁毒志愿者服务队]</div>
            <div class="listTime">发布时间：2019-10-07</div>
            <p class="XmlbListZhuantai" id="XmlbListZhuantai"
               style="position: absolute; top: 60px; right: 9px; color: black;width:auto"><img
                    src="__TMPL__statics/img/index/scan-count.png" alt="logo">&nbsp;</p></a></li>
        <li style="clear:both; overflow:hidden;position:relative;"><a
                href="">
            <p id="abc" class="XmlbListZhuantai XmlbListZhuantaiBgRed" style="position:absolute; top:10px;right:10px;">
                报名</p>            <img src="__TMPL__statics/img/index/defaultPic_2.jpg"
                                       class="XmlbListImg">
            <div class="listTitle">家访志愿活动</div>
            <div class="listOrg">[兴宁市善小助学协会]</div>
            <div class="listTime">发布时间：2019-10-07</div>
            <p class="XmlbListZhuantai" id="XmlbListZhuantai"
               style="position: absolute; top: 60px; right: 9px; color: black;width:auto"><img
                    src="__TMPL__statics/img/index/scan-count.png" alt="logo">&nbsp;</p></a></li>
    </ul>

    <div id="background" class="background" style="display: none;"></div>
    <div id="progressBar" class="progressBar" style="display: none;">
        <img style="width: 30px; height: 30px;" src="__TMPL__statics/img/index/loading.gif">
    </div>
    <div style="height: 50px; line-height: 50px; text-align: center; font-size: 14px;" id="loadMore">加载更多...</div>
</div>


<script type="text/javascript">
    // 点击改变背景颜色
    $('.XmlbListContainer>li').mousedown(function (event) {
        $(this).css('background-color', '#f3f3f3');
        $(this).siblings().css('background-color', '#fff');
    });
</script>

</div>
</body>
</html>